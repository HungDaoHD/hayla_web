<!-- Load template html -->
{% extends "./base.html" %}


<!-- Title -->
{% block title %}Calendar | Haylà{% endblock %}


<!-- [ breadcrumb ] start -->
{% block breadcrumb %}
<div class="col-md-12">
  <ul class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Home</a></li>
    <li class="breadcrumb-item"><a href="javascript: void(0)">Calendar</a></li>
    <li class="breadcrumb-item" aria-current="page">Reservation</li>
  </ul>
</div>

<div class="col-md-12">
  <div class="page-header-title">
    <h2 class="mb-0">Reservation</h2>
  </div>
</div>
{% endblock %}
<!-- [ breadcrumb ] end -->


<!-- [ Main Content ] start -->
{% block main_content %}
<div class="text-end p-2 pb-2">
  <!-- <a href="javascript:void(0)" class="btn btn-primary d-inline-flex align-item-center">  -->
    <!-- data-bs-toggle="offcanvas" data-bs-target="#calendar-reservation-add_edit_event" -->
    <!-- <i class="ti ti-plus f-18"></i>Add -->
  <!-- </a> -->

  <button id="btn-add-reservation" type="button" class="btn btn-primary d-inline-flex align-item-center">
    <span id="btn-add-reservation-text"><i class="align-text-bottom me-1 ti ti-plus"></i> Add</span>
  </button>

</div>

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-body position-relative">
        <div id="calendar-reservation" class="calendar"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="calendar-reservation-modal" data-bs-keyboard="false" tabindex="-1"> <!-- aria-hidden="true" -->
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      
      <div class="modal-header">
        <h3 class="calendar-modal-title f-w-600 text-truncate">Title</h3>
        <a href="#" class="avtar avtar-s btn-link-danger btn-pc-default" data-bs-dismiss="modal">
          <i class="ti ti-x f-20 text-danger"></i>
        </a>
      </div>
      
      <div class="modal-body">

        <div class="row g-3 align-items-start">

          <!-- People -->
          <div class="col-6">
            <div class="d-flex align-items-start gap-2">
              <div class="avtar avtar-xs bg-light-primary d-inline-flex justify-content-center align-items-center">
                <i class="ti ti-users f-20"></i>
              </div>
              <div>
                <p class="mb-1 text-muted fw-semibold">People</p>
                <h5 class="pc-event-people mb-0"></h5>
              </div>
            </div>
          </div>

          <!-- Venue -->
          <div class="col-6">
            <div class="d-flex align-items-start gap-2">
              <div class="avtar avtar-xs bg-light-info d-inline-flex justify-content-center align-items-center">
                <i class="ti ti-map-pin f-20"></i>
              </div>
              <div>
                <p class="mb-1 text-muted fw-semibold">Venue</p>
                <h5 class="pc-event-venue mb-0"></h5>
              </div>
            </div>
          </div>

          <!-- Date -->
          <div class="col-6">
            <div class="d-flex align-items-start gap-2">
              <div class="avtar avtar-xs bg-light-warning d-inline-flex justify-content-center align-items-center">
                <i class="ti ti-calendar-event f-20"></i>
              </div>
              <div>
                <p class="mb-1 text-muted fw-semibold">Date</p>
                <h5 class="pc-event-date mb-0"></h5>
              </div>
            </div>
          </div>

          <!-- Time -->
          <div class="col-6">
            <div class="d-flex align-items-start gap-2">
              <div class="avtar avtar-xs bg-light-danger d-inline-flex justify-content-center align-items-center">
                <i class="ti ti-alarm f-20"></i>
              </div>
              <div>
                <p class="mb-1 text-muted fw-semibold">Time</p>
                <h5 class="pc-event-time mb-0"></h5>
              </div>
            </div>
          </div>
          
          <!-- Status -->
          <div class="col-6">
            <div class="d-flex align-items-start gap-2">
              <div class="avtar avtar-xs bg-light-success d-inline-flex justify-content-center align-items-center">
                <i class="ti ti-info-square f-20"></i>
              </div>
              <div>
                <p class="mb-1 text-muted fw-semibold">Status</p>
                <h5 class="pc-event-status mb-0"></h5>
              </div>
            </div>
          </div>

          <!-- Description (full width) -->
          <div class="col-6">
            <div class="d-flex align-items-start gap-2">
              <div class="avtar avtar-xs bg-light-secondary d-inline-flex justify-content-center align-items-center">
                <i class="ti ti-file-text f-20"></i>
              </div>
              <div>
                <p class="mb-1 text-muted fw-semibold">Description</p>
                <h6 class="pc-event-description mb-0"></h6>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="modal-footer justify-content-between">
        <ul class="list-inline me-auto mb-0">
          <li class="list-inline-item align-bottom">
            <a href="#" id="pc_event_remove" class="avtar avtar-s btn-link-danger btn-pc-default w-sm-auto" data-bs-toggle="tooltip" title="Delete">
              <i class="ti ti-trash f-18 text-danger"></i>
            </a>
          </li>

          <li class="list-inline-item align-bottom">
            <a href="#" id="pc_event_edit" class="avtar avtar-s btn-link-success btn-pc-default" data-bs-toggle="tooltip" title="Edit">
              <i class="ti ti-edit-circle f-18 text-success"></i>
            </a>
          </li>
        </ul>
        
        <div class="flex-grow-1 text-end">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    
    </div>
  </div>
</div>

<div class="offcanvas offcanvas-end cal-event-offcanvas" tabindex="-1" id="calendar-reservation-add_edit_event" data-bs-keyboard="false">
    
  <div class="offcanvas-header">
    <h3 class="offcanvas_title f-w-600 text-truncate">Add Events</h3>
    <a href="#" class="avtar avtar-s btn-link-danger btn-pc-default text-danger" data-bs-dismiss="offcanvas">
      <i class="ti ti-x f-20"></i>
    </a>
  </div>
  
  <div class="offcanvas-body">
    
    <form id="form-reservation-add-edit" class="validate-me" data-validate>

      <input type="hidden" id="pc-e-oid">

      <div class="form-group">
        <label class="form-label">Customer name</label>
        <input type="text" class="form-control" id="pc-e-name" placeholder="Enter customer name" minlength="2" maxlength="30" required autofocus>
      </div>

      <div class="form-group">
        <label class="form-label">Number of people</label>
        <input type="number" class="form-control" id="pc-e-people" placeholder="Enter number of people" min="1", max="30" required>
      </div>
      
      <div class="form-group">
        <label class="form-label">Date</label>
        <input type="date" class="form-control" name=" date" id="pc-e-date" placeholder="mm/dd/yyyy" required>
      </div>

      <div class="form-group row">
        <div class="col-6">
          <label class="col-form-label text-lg-end">Start time</label>
          <select class="form-control" id="pc-e-stime" name=" stime" required></select>
        </div>
        
        <div class="col-6">
          <label class="col-form-label text-lg-end">End time</label>
          <select class="form-control" id="pc-e-etime" name=" etime" required></select>
        </div>

      </div>

      <div class="form-group row">
        <div class="col-6">
          <label class="form-label">Venue</label>
          <select class="form-control" id="pc-e-venue" name=" venue" required></select>
        </div>
        
        <div class="col-6">
          <label class="form-label">Status</label>
          <select class="form-control" id="pc-e-status" name=" status" required></select>
        </div>

      </div>
      
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-control" placeholder="Enter description (if any)" rows="2" id="pc-e-desc" name=" desc"></textarea>
      </div>

    </form>

    <div class="offcanvas-footer row justify-content-between">
      
      <div class="col-auto">
        <!-- <button id="btn-reservation-close" type="button" class="btn btn-link-danger btn-pc-default text-danger" data-bs-dismiss="offcanvas">
          <i class="align-text-bottom me-1 ti ti-circle-x"></i> Close
        </button> -->
      </div>
      
      <div class="col-auto">
        <button id="btn-reservation-submit" type="button" class="btn btn-primary" data-pc-action="add">
          
          <i class="spinner-border spinner-border-sm d-none" role="status"></i>
          <i class="align-text-bottom me-1 ti ti-calendar-plus"></i>
          
          <span id="btn-reservation-submit-text">Add</span>
          
        </button>
      </div>
    </div>
      
    

  </div>

</div>

{% endblock %}
<!-- [ Main Content ] end -->


{% block extra_scripts %}

  <!-- [Page Specific JS] start -->
  <!-- calendar js -->
  <script src="{{ request.url_for('static', path='js/plugins/index.global.min.js') }}"></script>

  <!-- Sweet Alert -->
  <script src="{{ request.url_for('static', path='js/plugins/sweetalert2.all.min.js') }}"></script>
  
  <!-- Calendar -->
  <script src="{{ request.url_for('static', path='js/pages/calendar-reservation.js') }}"></script>

  <!-- jquery-validation Js -->
  <script src="{{ request.url_for('static', path='js/plugins/bouncer.min.js') }}"></script>
  <script src="{{ request.url_for('static', path='js/pages/form-validation.js') }}"></script>

  <!-- tagify -->
  <script src="{{ request.url_for('static', path='js/plugins/choices.min.js') }}"></script>

  
  <!-- [Page Specific JS] end -->
  
  <!-- Avoid select previous date -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('pc-e-date');
      const today = new Date();
      
      // format as YYYY-MM-DD for <input type="date">
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      
      const todayStr = `${yyyy}-${mm}-${dd}`;
      input.min = todayStr;        // sets minimum to today
      // input.value = todayStr;      // optional: prefill with today
    });

  </script>
  
  <!-- Init choice elements -->
  <script>
    
    const elm_stime = [{ value: '', label: 'Select time', disabled: true, selected: true, placeholder: true }];
    const elm_etime = [{ value: '', label: 'Select time', disabled: true, selected: true, placeholder: true }];

    for (let h = 8; h <= 22; h++) {
      for (let m = 0; m < 60; m += 30) {
        const hh = String(h).padStart(2, '0');
        const mm = String(m).padStart(2, '0');

        if (h == 22 && m == 30){
          break;
        }

        elm_stime.push({ value: `${hh}:${mm}`, label: `${hh}:${mm}` });
      }
    }
    
    const choice_stime = new Choices('#pc-e-stime', {
      allowHTML: false,
      searchEnabled: true,
      shouldSort: false,
      placeholder: true,
      placeholderValue: 'Select time',
      itemSelectText: ''
    }).setChoices(elm_stime, 'value', 'label', true);
    
    const choice_etime = new Choices('#pc-e-etime', {
      allowHTML: false,
      searchEnabled: true,
      shouldSort: false,
      placeholder: true,
      placeholderValue: 'Select time',
      itemSelectText: ''
    }).setChoices(elm_etime, 'value', 'label', true);

    document.getElementById("pc-e-stime").addEventListener("change", function () {
      const startTime = this.value;
      
      if (!startTime) return; // nothing selected yet
      
      const startVal = parseInt(startTime.replace(":", ""), 10);
      
      const elm_etime = [{ value: '', label: 'Select time', disabled: true, selected: true, placeholder: true }];
      
      elm_stime.forEach((obj, i) => {
        
        if (obj.value) {
          const endVal = parseInt(obj.value.replace(":", ""), 10);
          
          if (endVal > startVal) {
            
            const duration = endVal - startVal;
            const hh = parseInt(duration / 100);
            const mm = duration % 100 > 0 ? 0.5 : 0;
            
            elm_etime.push({
              value: obj.value,
              label: `${obj.label} (${hh + mm} hr)` 
            });

          }
        };
      });
      
      choice_etime.clearChoices().setChoices(elm_etime);
    });

    
    const choice_venue = new Choices('#pc-e-venue', {
      allowHTML: false,
      searchEnabled: false,
      shouldSort: false,
      placeholder: true,
      placeholderValue: 'Select venue',
      itemSelectText: ''
    }).setChoices(
      [
        { value: '', label: 'Select venue', disabled: true, selected: true, placeholder: true },
        { value: 'Anywhere', label: 'Anywhere' },
        { value: 'Room 1', label: 'Room 1' },
        { value: 'Room 2', label: 'Room 2' },
        { value: 'Room 1 & 2', label: 'Room 1 & 2' },
        { value: 'Backroom', label: 'Backroom' },
        { value: 'Window table', label: 'Window table' },
        { value: 'Sofa', label: 'Sofa' }
      ]
    );


    const choice_status = new Choices('#pc-e-status', {
      allowHTML: false,
      searchEnabled: false,
      shouldSort: false,
      placeholder: true,
      placeholderValue: 'Select status',
      itemSelectText: ''
    }).setChoices(
      [
        { value: '', label: 'Select status', disabled: true, selected: false, placeholder: true },
        { value: 'Booking', label: 'Booking', disabled: false, selected: true},
        { value: 'Arrived', label: 'Arrived', disabled: true, selected: false},
        { value: 'Leaved', label: 'Leaved', disabled: true, selected: false},
        { value: 'Cancel', label: 'Cancel', disabled: true, selected: false},
      ]
    );

  </script>

  <!-- Init calendar with reservation form DB -->
  <script>
    const lst_reservation = {{ lst_reservation | tojson }};
    calendar_reservation.addEventSource(lst_reservation);
  </script>
  
  <!-- Add reservtion -->
  <script>

    $("#btn-add-reservation").on('click', function() {
      $calendaroffcanvas = $("#calendar-reservation-add_edit_event");
      $calendaroffcanvas.find('.offcanvas_title').text('Add New');
      $("#pc-form-event").find("#pc-e-oid").val('');
      $('#btn-reservation-submit-text').html('Add');
      calendaroffcanvas.show();
    });

    function toMongoDateFromMDY(dateStr, timeStr) {
      const [yyyy, mm, dd] = dateStr.split('-').map(s => parseInt(s, 10));
      const [HH, MM] = timeStr.split(':').map(s => parseInt(s, 10));

      // Build a local Date (browser’s timezone), then to UTC ISO "Z"
      const d = new Date(yyyy, mm - 1, dd, HH, MM, 0, 0);
      
      // return { $date: d.toISOString() };
      return d.toISOString();
    }


    const elm_reservation_id = {
      basic: {
        name: "#pc-e-name",
        people: "#pc-e-people",
        date: "#pc-e-date",
        desc: "#pc-e-desc",
      },
      choices: {
        start: "#pc-e-stime",
        end: "#pc-e-etime",
        venue: "#pc-e-venue",
        status: "#pc-e-status",
      }
    };

    function validate_reservation_input () {

      const isEmptyVal = (v) => v == null || (Array.isArray(v) ? v.length === 0 : String(v).trim() === "");
      var missing_count = 0;
      
      // BASIC (inputs, textareas, etc.)
      Object.values(elm_reservation_id.basic).forEach((sel) => {
        
        if(sel === '#pc-e-desc'){
          return;
        }
        
        const $el = $(sel);
        if (!$el.length) return;

        const v = $el.val();
        if (isEmptyVal(v)) {
          missing_count++;
          $el.addClass('border-danger');
        } else {
          $el.removeClass('border-danger');
        }
      });

      // CHOICES (selects enhanced by Choices.js)
      Object.values(elm_reservation_id.choices).forEach((sel) => {
        const $select = $(sel);
        if (!$select.length) return;

        if (isEmptyVal($select.val())) {
          
          missing_count++;
          $select.parent().addClass('border-danger');
          
        } else {

          $select.parent().removeClass('border-danger');
        
        }
      });

      return missing_count;
    }


    function disable_input_elements($btnSubmit, isDisable) {

      if(isDisable){
        $('#calendar-reservation-add_edit_event [data-bs-dismiss="offcanvas"]').prop('disabled', isDisable);

        $btnSubmit.prop('disabled', isDisable);
        $btnSubmit.find(".spinner-border").removeClass('d-none');
        $btnSubmit.find(".ti-calendar-plus").addClass('d-none');

        document.querySelectorAll(Object.values(elm_reservation_id.basic).join(', ')).forEach(el => el.disabled = true);
        choice_stime.disable();
        choice_etime.disable();
        choice_venue.disable();
        choice_status.disable();
      }
      else {
        $('#calendar-reservation-add_edit_event [data-bs-dismiss="offcanvas"]').prop('disabled', isDisable);
        
        $btnSubmit.prop('disabled', isDisable);
        $btnSubmit.find(".spinner-border").addClass('d-none');
        $btnSubmit.find(".ti-calendar-plus").removeClass('d-none');
        
        document.querySelectorAll(Object.values(elm_reservation_id.basic).join(', ')).forEach(el => el.disabled = isDisable);
        choice_stime.enable();
        choice_etime.enable();
        choice_venue.enable();
        choice_status.enable();
      }

    }



    $("#btn-reservation-submit").on('click', function() {

      var missing_count = validate_reservation_input();
      
      if (missing_count !== 0){
        Swal.fire('Please input all information.', 'except description', 'error');
        return;
      }
      
      disable_input_elements($(this), true);

      Swal.fire({
          title: 'Do you want do add this reservation?',
          showDenyButton: true,
          showCancelButton: false,
          confirmButtonText: 'Yes',
          denyButtonText: 'No',
          allowOutsideClick: false,
          allowEscapeKey: false,
          allowEnterKey: false,
        }).then((result) => {
          
          if (result.isDenied) 
          {
            disable_input_elements($(this), false);
            return;
          }
          else if (result.isConfirmed) {
            
            obj_reservation = {
              name: $("#pc-e-name").val(),
              people: $("#pc-e-people").val(),
              start: toMongoDateFromMDY($("#pc-e-date").val(), $("#pc-e-stime").val()),
              end: toMongoDateFromMDY($("#pc-e-date").val(), $("#pc-e-etime").val()),
              venue: $("#pc-e-venue").val(),
              status: $("#pc-e-status").val(),
              desc: $("#pc-e-desc").val(),
              allDay: false,
              inputer: "hungdao1991@live.com",
            };
            
            console.log(obj_reservation);
            

            $.ajax({
              url: '/calendar/reservation/add',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify(obj_reservation),

              success: function(obj_added) {

                Swal.fire('Add reservation successfully!', Object.values(obj_added).join(', '), 'success').then(() => {
                  disable_input_elements($(this), false);
                }).then((result) => {
                  window.location.reload();
                });
                
              },

              error: function(xhr, status, err) {
                
                console.error(xhr);
                console.error(status);
                console.error(err);
                
                function getErrorMessagesFromXhr(xhr) {
                  // Prefer JSON if present
                  const rj = xhr.responseJSON;
                  if (rj && rj.detail !== undefined) {

                    const d = rj.detail;
                    
                    if (Array.isArray(d)) {
                      
                      // FastAPI validation errors: [{loc: [...], msg: "...", type: "..."}]
                      
                      if ((d[0]?.msg === "Field required" || d[0]?.message === "Field required") && d[0].type === "missing" && (d[0].loc[1] === "email" || d[0].loc[1] === "password")) {
                        return "Vui lòng đăng nhập!!!";
                      }
                      else {
                        return d.map(item => item?.msg || item?.message || (typeof item === 'string' ? item : JSON.stringify(item))).join(', ');
                      }
                      

                    } else {
                      // Sometimes FastAPI sends {detail: "message"} or {detail: {...}}
                      return [typeof d === 'string' ? d : (d.msg || d.message || JSON.stringify(d))].join(', ');
                    }
                    
                    
                  }

                  // Fallbacks: try to parse text or show status text
                  try {
                    const parsed = JSON.parse(xhr.responseText);
                    if (parsed?.detail) return [parsed.detail].join(', ');
                  } catch (_) {}
                  
                  return [xhr.statusText || 'Unknown error'].join(', ');
                }
              
                Swal.fire(getErrorMessagesFromXhr(xhr), 'Phát sinh lỗi. Dữ liệu chưa được lưu.', 'error').then((result) => {
                  window.location.reload();
                });
                
              }
            });

          }

        });


      

      


    });















  </script>

  
{% endblock %}







