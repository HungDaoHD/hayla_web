<!-- Load template html -->
{% extends "./base.html" %}

{% set str_title = 'Stock' %}

<!-- Title -->
{% block title %} {{ str_title ~ ' | Haylà' }} {% endblock %}


<!-- [ breadcrumb ] start -->
{% block breadcrumb %}
<div class="col-md-12">
  <ul class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Home</a></li>
    <li class="breadcrumb-item"><a href="javascript: void(0)">Operation</a></li>
    <li class="breadcrumb-item" aria-current="page">{{ str_title }}</li>
  </ul>
</div>

<div class="col-md-12">
  <div class="page-header-title">
    <h2 class="mb-0">{{ str_title }}</h2>
  </div>
</div>
{% endblock %}
<!-- [ breadcrumb ] end -->


<!-- [ Main Content ] start -->
{% block main_content %}

<!-- TAB NAME -->
{% set lst_tabname = ['input', 'items', 'summary'] %}

<ul class="nav nav-pills p-2" id="pills-tab" role="tablist">

  {% for tabname in lst_tabname %}

    <li class="nav-item">
      <a class="nav-link {{ 'active' if tabname == 'input' else '' }}" id="pills-{{ tabname }}-tab"
         data-bs-toggle="pill" href="#pills-{{ tabname }}" role="tab" aria-controls="pills-{{ tabname }}"
         aria-selected="true">
        
        {{ tabname | capitalize }}
        
      </a>
    </li>
  
  {% endfor %}

</ul>

<!-- TAB CONTENT -->
<div class="tab-content" id="pills-tabContent">

  {% for tabname in lst_tabname %}

    <div class="tab-pane fade show {{ 'active' if tabname == 'input' else '' }}" id="pills-{{ tabname }}" role="tabpanel" aria-labelledby="pills-{{ tabname }}-tab">

        {% if tabname == 'input' %}
          <div class="card">            
            <div class="card-body">
              <div class="row">

                <!-- Select METHOD -->
                <div class="col-lg-10 col-md-9 col-8 p-1">
                  <form class="was-validated">
                    <label for="stock-method-select" class="form-label d-none">Tác vụ</label>
                    <select id="stock-method-select" class="form-select" required>
                      <option value="">--Tác vụ--</option>
                      <option value="add">Nhập hàng</option>
                      <option value="get">Lấy hàng</option>
                      <option value="check">Kiểm kho</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn tác vụ</div>
                  </form>
                </div>

                <!-- Button SUMIT -->
                <div class="col-lg-2 col-md-3 col-4 text-end p-1">
                  <button id="btn-stock-submit" type="button" class="btn btn-primary w-100 w-md-auto" disabled>
                    <span class="btn-text">Submit</span>
                    <span class="count-items"></span>
                    <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                  </button>
                </div>
                
                

                <!-- STOCK ITEMS TABLE--------------------------------------->
                <div class="col-lg-12 col-md-12 col-12 p-1">
                  
                  <div id="stock-table-container" class="dt-responsive table-responsive d-none">
                    
                    <table id="dt-stock" class="table table-hover table-bordered table-sm align-middle">
                      <thead>
                        <tr>
                          <th style="width:5%; text-align:center; vertical-align:middle;">
                            <div class="form-check d-inline-block">
                              <input class="form-check-input" type="checkbox" id="select-all"> All
                            </div>
                          </th>
                          <th>Nguyên liệu</th>
                          <th>Trong kho</th>
                          <th>Ngoài kho</th>
                        </tr>
                      </thead>
                    
                      <tbody>
                        {% set ns = namespace(count=0) %}

                        {% for grp, lst_rig in dict_raw_ingredient.items() %}

                          {% for rig in lst_rig %}
                            {% set ns.count = ns.count + 1 %}
                            <tr data-id="{{ rig.Raw_Ingredient_ID }}" data-name="{{ rig.Raw_Ingredient_Name }}" data-loc="{{ user.location }}" data-target="#{{ rig.Raw_Ingredient_ID }}-qty">
                              
                              <td style="text-align:center; vertical-align:middle;">
                                <div class="form-check d-inline-block">
                                  <input class="form-check-input select-row" type="checkbox" data-target="#{{ rig.Raw_Ingredient_ID }}-qty">
                                </div>
                              </td>

                              <td>{{ ns.count }}. {{ rig.Raw_Ingredient_Name }}</td>
                              
                              <td>
                                <!-- <form class="was-validated"> -->
                                  <input type="number" id="{{ rig.Raw_Ingredient_ID }}-qty-instock" class="form-control d-none" step="any" 
                                  name="{{ rig.Raw_Ingredient_ID }}-qty-instock" placeholder="Trong kho" disabled required>
                                  <!-- <div class="invalid-feedback">Vui lòng nhập số</div> -->
                                <!-- </form> -->
                              </td>
                              
                              <td>
                                <!-- <form class="was-validated"> -->
                                  <input type="number" id="{{ rig.Raw_Ingredient_ID }}-qty-outstock" class="form-control d-none" step="any" 
                                  name="{{ rig.Raw_Ingredient_ID }}-qty-outstock" placeholder="Ngoài kho" disabled required>
                                  <!-- <div class="invalid-feedback">Vui lòng nhập số</div> -->
                                <!-- </form> -->
                              </td>
                            </tr>
                          {% endfor %}
                        
                        {% endfor %}

                        
                        
                      </tbody>
                    </table>

                  </div>

                </div>
                
              </div>
              
              
              
            </div>
          </div>
        
        {% elif tabname == 'items' %}
          
          <div class="card">
            <div class="card-body">
							
							<div class="text-end p-2 pb-2">
								<button id="btn-delete-items" class="btn btn-danger" disabled>
									<i class="ti ti-trash"></i> Xóa <span class="count-items"></span>
								</button>
							</div>
              
							<div class="stt-loading">
								<span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>Loading, please wait...
							</div>

              <div id="stock-items-table-container" class="dt-responsive table-responsive">
                
                <table id="dt-stock-items" class="table table-hover table-bordered table-sm align-middle mobile-cards">
                  
                </table>

              </div>
              
            </div>

          </div>
          
        {% else %}
          
          <div class="card">
            <div class="card-body">
              
              <div class="row">
                
                <div class="col-lg-10 col-md-9 col-8 p-1">
                  <form class="was-validated">
                    <label for="stock-summary-select" class="form-label d-none">Quán</label>

                    <select id="stock-summary-select" class="form-select" required>
                      <option value="">--Quán--</option>
                      <option value="SGN">SGN</option>
                      <option value="NTR">NTR</option>
                    </select>

                    <div class="invalid-feedback">Vui lòng chọn quán</div>
                  </form>
                </div>

                <!-- Button SUMIT -->
                <div class="col-lg-2 col-md-3 col-4 text-end p-1">
                  <button id="btn-summary-submit" type="button" class="btn btn-primary w-100 w-md-auto" disabled>
                    <span class="btn-text">Submit</span>
                    <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                  </button>
                </div>
                
                <div id="stock-summary-table-container" class="dt-responsive table-responsive">
                  

                </div>

              </div>
              
            </div>
          </div>
          
        {% endif %}
      
    </div>

  {% endfor %}

</div>

{% endblock %}
<!-- [ Main Content ] end -->



{% block extra_scripts %}

<script src="{{ request.url_for('static', path='js/plugins/choices.min.js') }}"></script>
<script src="{{ request.url_for('static', path='js/plugins/bouncer.min.js') }}"></script>
<script src="{{ request.url_for('static', path='js/pages/form-validation.js') }}"></script>
<script src="{{ request.url_for('static', path='js/plugins/sweetalert2.all.min.js') }}"></script>
<script src="{{ request.url_for('static', path='js/plugins/jquery.dataTables.min.js') }}"></script>
<script src="{{ request.url_for('static', path='js/plugins/dataTables.bootstrap5.min.js') }}"></script>

<script>
  // Tab INPUT -----------------------------------------------------------------------------------------------------------------------------------------------------
  $(function () {

    
    // Define elements
    const $btn_stock_submit = $("#btn-stock-submit");
    const $stock_table_container = $('#stock-table-container');
    const $dt_stock = $('#dt-stock');
    const $sel_stock_method = $('#stock-method-select');
    

    // Initialize input table
    function fnc_init_dt_stock() {

      // destroy any existing DataTable instance
      if ($.fn.DataTable.isDataTable($dt_stock)) {
        $dt_stock.DataTable().destroy();
      }
      
      $dt_stock.DataTable({
        responsive: false,
        scrollX: false,
        autoWidth: false,
        ordering: false,

        // 1) Custom DOM: length + filter row on top, info + paginate row on bottom
        dom:
          "<'row g-2 p-2 mb-3'" +
          "<'col-sm-8'l>" +   // length menu here
          "<'col-sm-4'f>" +   // filter input here
          ">" +
          "t" +                 // the table itself
          "<'row g-2 p-2 mt-3'" +
            "<'col-sm-8'i>" +   // table info here
            "<'col-sm-4'p>" +   // pagination here
          ">",
        
        // 2) Language tweaks
        language: {
          lengthMenu: 'Show _MENU_ entries',
          search: '', // remove default “Search:” label
          searchPlaceholder: 'Search…',
          paginate: {
            first:    '<i class="ti ti-chevrons-left"></i>',
            previous: '<i class="ti ti-chevron-left"></i>',
            next:     '<i class="ti ti-chevron-right"></i>',
            last:     '<i class="ti ti-chevrons-right"></i>'
          }
        },

        // 3) Optional: how many rows by default
        pageLength: 100

      });

      const wrap = '#dt-stock_wrapper';
      $(wrap + ' .dataTables_length select').addClass('form-select form-select-sm');
      $(wrap + ' .dataTables_filter label').addClass('d-flex justify-content-end');
      $(wrap + ' .dataTables_filter input').addClass('form-control form-control-sm');

    }
    

    // helper: get all checked rows (works across pages if DataTables is used)
    function getSelectedItems() {
      
      const $items_checked = $dt_stock.find('input.select-row:checked');
      var lst_stock_items = []; 
      var total_qty = 0;
      if (!$items_checked.length) {
        return {lst_stock_items, total_qty};
      }

			$items_checked.each(function () {
				
        const $tr = $(this).closest('tr');  
        const inVal  = parseFloat($tr.find(`input[id='${$tr.data('id')}-qty-instock']`).val()) || 0;
        const outVal = parseFloat($tr.find(`input[id='${$tr.data('id')}-qty-outstock']`).val()) || 0;

        lst_stock_items.push({
          Raw_Ingredient_ID: $tr.data('id'),
          Raw_Ingredient_Name: $tr.data('name'),
          Location: $tr.data('loc'),
          Method: $sel_stock_method.val(),
          Qty_Instock: inVal,
          Qty_Outstock: outVal,
        });
        
        total_qty += (inVal + outVal);

      });

      // console.log(lst_stock_items);
      
			return {lst_stock_items, total_qty};
		}


    // Clear Input Qty
    function fnc_clear_input_qty(row) {

      const $qty_instock = $(`${$(row).data('target')}-instock`);
      const $qty_outstock = $(`${$(row).data('target')}-outstock`);

      $qty_instock.val(null);
      $qty_outstock.val(null);

      if (row.checked) {
        $qty_instock.removeClass('d-none').prop('disabled', false);
        $qty_outstock.removeClass('d-none').prop('disabled', false);
        
      } else {
        $qty_instock.addClass('d-none').prop('disabled', true);
        $qty_outstock.addClass('d-none').prop('disabled', true);
      }

    }
    
    // When "select all" is clicked
    $('#select-all').on('change', function () {
      const checked = this.checked;
      $('#dt-stock .select-row').prop('checked', checked).trigger('change');
    });

    // If any single row is unchecked -> uncheck master
    $('#dt-stock').on('change', '.select-row', function () {
      const allRows = $('#dt-stock .select-row').length;
      const checkedRows = $('#dt-stock .select-row:checked').length;
      $('#select-all').prop('checked', allRows === checkedRows);
    });
    

    $sel_stock_method.on('change', function () {
      
      // CALL FUNCTION
      fnc_init_dt_stock();

      if ($.fn.DataTable.isDataTable($dt_stock)) {
        
        $dt = $dt_stock.DataTable();
        $qty_outstock_col = $dt.column(3);

      }
      
      $qty_outstock_col.visible(false);
            
      if ($(this).val() == '') {
        $btn_stock_submit.prop('disabled', true);
        $stock_table_container.addClass('d-none'); 
      }
      else {
        $stock_table_container.removeClass('d-none');
      
        if ($(this).val() == 'check') {
          $qty_outstock_col.visible(true);
        }

      }
      
      // uncheck ALL checkboxes across pages
      $dt.$('input[type="checkbox"]').prop('checked', false).trigger('change');

      // clear text/number/date inputs
      $dt.$('input[type="text"], input[type="number"], input[type="date"], input[type="time"]').val('').trigger('input');

    });
    

		// enable/disable delete button when selection changes
		$(document).on('change', '#dt-stock input.select-row', function () {
      const obj = getSelectedItems();
      const n = obj.lst_stock_items.length;
      
      $btn_stock_submit.prop('disabled', n === 0).find('.count-items').text(n ? `(${n})` : '');
      // $btn_stock_submit.prop('disabled', true).find('.count-items').text(n ? `(${n})` : '');
      fnc_clear_input_qty(this);
    });
    

    
    


    // SUBMITING
    $btn_stock_submit.on('click', function () {
      
      const obj_items = getSelectedItems();

      if (obj_items.total_qty === 0)
      {
        Swal.fire('Bạn chưa nhập bất kỳ số lượng nào!', '', 'error');
        return;
      }


      if ($sel_stock_method.val() === 'check') {
        // all number inputs must be filled
        const $nums = $dt_stock.find('tbody input[type=number]');
        const allFilled = $nums.toArray().every(el => el.value.trim() !== '');

        if (!allFilled) {
          Swal.fire('Tác vụ kiểm kho cần nhập tất cả nguyên liệu!', '', 'error');
          return;
        }

      }

      var lst_mising = [];

      obj_items.lst_stock_items.forEach((item, idx) => {
        
        if (item.Method === 'get' || item.Method === 'add') {
          if (item.Qty_Instock + item.Qty_Outstock === 0) {
            lst_mising.push(item.Raw_Ingredient_Name);
          }          
        }
      });

      if (lst_mising.length) {
        Swal.fire(`Bạn chưa nhập các nguyên liệu:`, lst_mising.join('<br/>'), 'error');
        return;
      }
      

      $btn_stock_submit.prop('disabled', true).find('.btn-text').text('Please wait…');
      $btn_stock_submit.find('.spinner-border').removeClass('d-none');

      Swal.fire({
        title: `Bạn có muốn lưu (${obj_items.lst_stock_items.length}) dữ liệu đã nhập?`,
        showDenyButton: true,
        showCancelButton: false,
        confirmButtonText: `Lưu`,
        denyButtonText: `Không`
      }).then((result) => {
        
        if (result.isDenied) 
        {
          $btn_stock_submit.prop('disabled', false).find('.btn-text').text('Submit');
          $btn_stock_submit.find('.spinner-border').addClass('d-none');
          return;
        }
        else if (result.isConfirmed) {

          $.ajax({
            url: '/operation/stock/insert-items',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(obj_items.lst_stock_items),
            success: function(resp) {

              Swal.fire('Lưu dữ liệu thành công!', '', 'success').then(() => {
                $sel_stock_method.val('').trigger('change');
                $btn_stock_submit.prop('disabled', false).find('.btn-text').text('Submit');
                $btn_stock_submit.find('.spinner-border').addClass('d-none');

              });
              
            },
            error: function(xhr, status, err) {
              
              $btn_stock_submit.prop('disabled', false).find('.btn-text').text('Submit');
              $btn_stock_submit.find('.spinner-border').addClass('d-none');
              
              console.error(xhr);
              console.error(status);
              console.error(err);
              
              
              function getErrorMessagesFromXhr(xhr) {
                // Prefer JSON if present
                const rj = xhr.responseJSON;
                if (rj && rj.detail !== undefined) {

                  const d = rj.detail;
                  
                  if (Array.isArray(d)) {
                    
                    // FastAPI validation errors: [{loc: [...], msg: "...", type: "..."}]
                    
                    if ((d[0]?.msg === "Field required" || d[0]?.message === "Field required") && d[0].type === "missing" && (d[0].loc[1] === "email" || d[0].loc[1] === "password")) {
                      return "Vui lòng đăng nhập!!!";
                    }
                    else {
                      return d.map(item => item?.msg || item?.message || (typeof item === 'string' ? item : JSON.stringify(item))).join(', ');
                    }
                    

                  } else {
                    // Sometimes FastAPI sends {detail: "message"} or {detail: {...}}
                    return [typeof d === 'string' ? d : (d.msg || d.message || JSON.stringify(d))].join(', ');
                  }
                  
                  
                }

                // Fallbacks: try to parse text or show status text
                try {
                  const parsed = JSON.parse(xhr.responseText);
                  if (parsed?.detail) return [parsed.detail].join(', ');
                } catch (_) {}
                
                return [xhr.statusText || 'Unknown error'].join(', ');
              }




              Swal.fire('Phát sinh lỗi. Dữ liệu chưa được lưu.', getErrorMessagesFromXhr(xhr), 'error');
            }
          });

        }

      });
      
    
    });
  
  
  });



  // Tab ITEMS -----------------------------------------------------------------------------------------------------------------------------------------------------
  $(function () {
    
		const $stt_loading = $('#pills-items').find('.stt-loading');
    const $stock_items_container = $('#stock-items-table-container');
    const $dt_stock_items = $('#dt-stock-items');

    // small helpers
    const esc = s => $('<div>').text(s ?? '').html();
    const num = v => (v ?? 0).toLocaleString('en-US', { maximumFractionDigits: 2 });
    const methodColor = m => ({ add: 'primary', get: 'warning', check: 'info' }[m] || 'info');
		const methodLabel = m => ({ add: 'Nhập hàng', get: 'Lấy hàng', check: 'Kiểm kho' }[m] || 'info');

    function renderStockItemsTable(rows) {
      // destroy any existing DataTable instance
      if ($.fn.DataTable.isDataTable($dt_stock_items)) {
        $dt_stock_items.DataTable().destroy();
      }
      $dt_stock_items.empty();

      // define the columns you want
      const cols = [
        { title: '#'},
				{ title: 'ID'},
				{ title: 'Nguyên liệu'},
        { title: 'Ngày Giờ'},
        { title: 'Tài khoản'},
        { title: 'Quán'},
        { title: 'Tác vụ'},
        { title: 'Trong kho'},
        { title: 'Ngoài kho'},
      ];
      
      // build thead
      const thead = `<thead><tr>${cols.map(c => `<th style="width:10%; text-align:center; vertical-align:middle;">${c.title}</th>`).join('')}</tr></thead>`;
      
      // build tbody
      const tbody = `<tbody>
        ${rows.map((r, i) => `
          <tr data-id="${esc(r.id)}">

            <td style="text-align:center; vertical-align:middle;" data-label="">
              <div class="form-check d-inline-block">
                <input class="form-check-input select-row" type="checkbox">
              </div>
            </td>

						<td data-label="ID">${esc(r.Raw_Ingredient_ID)}</td>
						<td data-label="Nguyên liệu">${esc(r.Raw_Ingredient_Name)}</td>
            <td data-label="Ngày giờ">${esc(r.DateTime)}</td>
            <td data-label="Tài khoản">${esc(r.email)}</td>
            <td data-label="Quán">${esc(r.Location)}</td>
            
            <td data-label="Tác vụ">
              <span class="badge bg-light-${methodColor(r.Method)} border border-${methodColor(r.Method)} f-14">
                ${esc(methodLabel(r.Method))}
              </span>
            </td>
            <td data-label="Trong kho" class="text-end">${num(r.Qty_Instock)}</td>
            <td data-label="Ngoài kho" class="text-end">${num(r.Qty_Outstock)}</td>
          </tr>
        `).join('')}
      </tbody>`;

      // insert and (re)initialize DataTables
      $dt_stock_items.html(thead + tbody).DataTable({
				responsive: false, // we’ll do our own card layout
        dom:
          "<'row g-2 p-2 mb-3'<'col-sm-8'l><'col-sm-4'f>>" +
          "t" +
          "<'row g-2 p-2 mt-3'<'col-sm-8'i><'col-sm-4'p>>",
        pageLength: 10,
        order: [[0, 'desc']], // default sort by #; change if you prefer
        language: {
          lengthMenu: 'Show _MENU_ entries',
          search: '',
          searchPlaceholder: 'Search…',
          paginate: {
            first: '<i class="ti ti-chevrons-left"></i>',
            previous: '<i class="ti ti-chevron-left"></i>',
            next: '<i class="ti ti-chevron-right"></i>',
            last: '<i class="ti ti-chevrons-right"></i>'
          }
        }
      });

      // style the controls for this table only
      const wrap = '#dt-stock-items_wrapper';
      $(wrap + ' .dataTables_length select').addClass('form-select form-select-sm');
      $(wrap + ' .dataTables_filter label').addClass('d-flex justify-content-end');
      $(wrap + ' .dataTables_filter input').addClass('form-control form-control-sm');
    }

		$stt_loading.removeClass('d-none');
    $stock_items_container.addClass('d-none');
    
    function fnc_init_stock_items() {
      
			$stt_loading.removeClass('d-none');
			$stock_items_container.addClass('d-none');

			$.ajax({
				url: '/operation/stock/retrieve-items',
				method: 'GET',
				success: function(resp) {
					
					renderStockItemsTable(resp);
					
          $stt_loading.addClass('d-none');
					$stock_items_container.removeClass('d-none');

					// setInterval(() => {
					// }, 300);
					
				},
				error: function(xhr, status, err) {
					console.error(xhr);
					console.error(status);
					console.error(err);
					Swal.fire('Phát sinh lỗi.', xhr.responseJSON.detail[0].msg, 'error');
				}
			});

    }
    
    // fires when the Items pill becomes active
    $('#pills-items-tab').on('shown.bs.tab', function (e) {
      // e.target is the newly activated <a>
			// console.log('#pills-items-tab showed!');
      fnc_init_stock_items?.();
		});
		
		// fires AFTER the Items tab is deactivated
		$('#pills-items-tab').on('hidden.bs.tab', function (e) {
			// console.log('Items tab is now inactive');
			$stt_loading.removeClass('d-none');
			$stock_items_container.addClass('d-none');
		});

    // also run on first load if it's already active
    if ($('#pills-items').hasClass('active')) {
      // console.log('#pills-items activated!');
      fnc_init_stock_items?.();
    }


		// DELETE STOCK ITEMS
		const dt = $.fn.DataTable.isDataTable($dt_stock_items) ? $dt_stock_items.DataTable() : null;

		// helper: get all checked rows (works across pages if DataTables is used)
		function getSelected() {
			const $checks = dt ? dt.$('input.select-row:checked') : $dt_stock_items.find('input.select-row:checked');

			const ids  = [];
			const rows = [];

			$checks.each(function () {
				const $tr = $(this).closest('tr');
				const id  = $tr.data('id');
				if (id) { ids.push(id); rows.push($tr); }
			});
			return { ids, rows };
		}

		// enable/disable delete button when selection changes
		$(document).on('change', '#dt-stock-items input.select-row', function () {
			const n = getSelected().ids.length;
			$('#btn-delete-items').prop('disabled', n === 0).find('.count-items').text(n ? `(${n})` : '');
		});

		
		// delete click
		$('#btn-delete-items').on('click', function () {
			const { ids, rows } = getSelected();
			if (!ids.length) return;

			// console.log(ids);
      

			Swal.fire({
				title: `Xóa ${ids.length} mục?`,
				text: 'Thao tác không thể hoàn tác.',
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'Xóa',
				cancelButtonText: 'Hủy',
				confirmButtonColor: '#dc3545'
			}).then(res => {

				if (!res.isConfirmed) return;

				const $btn = $('#btn-delete-items'); 
        $btn.prop('disabled', true).addClass('disabled');
				
				$.ajax({
					url: '/operation/stock/delete-items',
					method: 'POST',
					contentType: 'application/json',
					data: JSON.stringify({ ids }),

					success: function (resp) {
						
						if (dt) {
							rows.forEach($tr => dt.row($tr).remove());
							dt.draw(false);
						} else {
							rows.forEach($tr => $tr.remove());
						}

						$btn.prop('disabled', true).addClass('disabled').find('.count-items').text('');
						Swal.fire('Đã xóa!', '', 'success');
					
					},

					error: function (xhr) {
						const msg = xhr.responseJSON?.detail || xhr.statusText || 'Error';
						Swal.fire('Xóa thất bại', msg, 'error');
					},
					
					complete: function () {
						$btn.prop('disabled', true).addClass('disabled').find('.count-items').text('');
					}
				});
			
			});
		});

    

  });


  // Tab SUMMARY -----------------------------------------------------------------------------------------------------------------------------------------------------
  $(function () {
    
    const $sel_summary_location = $('#stock-summary-select'); 
    const $btn_summary_submit = $('#btn-summary-submit');
    const $stock_summary_container = $('#stock-summary-table-container');
    const $dt_stock_summary = $('#dt-stock-summary');

    $sel_summary_location.on('change', function () {

      if ($(this).val() == '') {
        $btn_summary_submit.prop('disabled', true);
      }
      else {
        $btn_summary_submit.prop('disabled', false);
      }

    });

    $btn_summary_submit.on('click', function () {
      
      $(this).prop('disabled', true).find('.btn-text').text('Please wait…');
      $(this).find('.spinner-border').removeClass('d-none');
      $sel_summary_location.prop('disabled', true);
      
      obj_fil = {
        Location: $sel_summary_location.val(),
      }

      console.log(obj_fil);

      $.ajax({
        url: '/operation/stock/summary',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(obj_fil),

        success: function (resp) {
          
          $stock_summary_container.html(resp.dt_summary_stock);
          
          const $dt_stock_summary = $('#dt-stock-summary').DataTable({
            dom:
              "<'row g-2 p-2 mb-3'" +
              "<'col-sm-8'l>" +   // length menu here
              "<'col-sm-4'f>" +   // filter input here
              ">" +
              "t" +                 // the table itself
              "<'row g-2 p-2 mt-3'" +
                "<'col-sm-8'i>" +   // table info here
                "<'col-sm-4'p>" +   // pagination here
              ">",
            // order: [[6, 'asc']],
            language: {
              lengthMenu: 'Show _MENU_ entries',
              search: '',
              searchPlaceholder: 'Search…',
              paginate: {
                first:    '<i class="ti ti-chevrons-left"></i>',
                previous: '<i class="ti ti-chevron-left"></i>',
                next:     '<i class="ti ti-chevron-right"></i>',
                last:     '<i class="ti ti-chevrons-right"></i>'
              }
            },
            pageLength: 10,
          });


          $('.dataTables_length select').addClass('form-select form-select-sm');
          $('.dataTables_filter label').addClass('d-flex justify-content-end');
          $('.dataTables_filter input').addClass('form-control form-control-sm');


          Swal.fire('Summary thành công!', '', 'success');
          
          
          

        },

        error: function (xhr) {
          
          const msg = xhr.responseJSON?.detail || xhr.statusText || 'Error';
          Swal.fire('Summary thất bại', msg, 'error');
        
          
        },
        
        complete: function () {
          $sel_summary_location.val('');
          $sel_summary_location.prop('disabled', false);
          $btn_summary_submit.prop('disabled', true).find('.btn-text').text('Submit');
          $btn_summary_submit.find('.spinner-border').addClass('d-none');
        }
      });

      
		});

    

  });


</script>


{% endblock %}







