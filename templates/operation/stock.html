<!-- Load template html -->
{% extends "./base.html" %}

{% set str_title = 'Stock' %}

<!-- Title -->
{% block title %} {{ str_title ~ ' | Haylà' }} {% endblock %}


<!-- [ breadcrumb ] start -->
{% block breadcrumb %}
<div class="col-md-12">
  <ul class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Home</a></li>
    <li class="breadcrumb-item"><a href="javascript: void(0)">Operation</a></li>
    <li class="breadcrumb-item" aria-current="page">{{ str_title }}</li>
  </ul>
</div>

<div class="col-md-12">
  <div class="page-header-title">
    <h2 class="mb-0">{{ str_title }}</h2>
  </div>
</div>
{% endblock %}
<!-- [ breadcrumb ] end -->


<!-- [ Main Content ] start -->
{% block main_content %}

<!-- TAB NAME -->
{% set lst_tabname = ['input', 'items', 'summary'] %}

<ul class="nav nav-pills p-2" id="pills-tab" role="tablist">

  {% for tabname in lst_tabname %}

    <li class="nav-item">
      <a class="nav-link {{ 'active' if tabname == 'input' else '' }}" id="pills-{{ tabname }}-tab"
         data-bs-toggle="pill" href="#pills-{{ tabname }}" role="tab" aria-controls="pills-{{ tabname }}"
         aria-selected="true">
        
        {{ tabname | capitalize }}
        
      </a>
    </li>
  
  {% endfor %}

</ul>

<!-- TAB CONTENT -->
<div class="tab-content" id="pills-tabContent">

  {% for tabname in lst_tabname %}

    <div class="tab-pane fade show {{ 'active' if tabname == 'input' else '' }}" id="pills-{{ tabname }}" role="tabpanel" aria-labelledby="pills-{{ tabname }}-tab">

        {% if tabname == 'input' %}
          <div class="card">
            
            <div class="card-body">
              
              <form class="was-validated" id="form-stock">  
                <div class="form-group row">
                  
                  <div class="col-lg-10 mb-3">
                    <select id="stock-method" class="form-select" required aria-label="select example">
                      <option value="">Tác vụ</option>
                      <option value="add">Nhập hàng</option>
                      <option value="get">Lấy hàng</option>
                      <option value="check">Kiểm kho</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn tác vụ</div>
                  </div>
                  
                  <div class="col-lg-2">
                    <button id="btn-stock-submit" type="button" class="btn btn-primary w-100" disabled>
                      <span class="btn-text">Submit</span>
                      <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                    </button>
                  </div>

                </div>  
              </form>
                
              <!-- INPUT TABLE--------------------------------------->
              <div id="stock-table-container" class="dt-responsive table-responsive p-1">

                <table id="dt-stock" class="table table-striped table-bordered table-sm align-middle">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Name</th>
                      <th>Trong kho</th>
                      <th>Ngoài kho</th>
                    </tr>
                  </thead>
                
                  <tbody>
                    {% set ns = namespace(count=0) %}

                    {% for grp, lst_rig in dict_raw_ingredient.items() %}

                      {% for rig in lst_rig %}
                        {% set ns.count = ns.count + 1 %}
                        <tr data-id="{{ rig.Raw_Ingredient_ID }}" data-loc="{{ user.location }}" data-target="#{{ rig.Raw_Ingredient_ID }}-qty">
                          
                          <td>
                            <div class="form-check">
                              <input class="form-check-input toggle-row" type="checkbox" data-target="#{{ rig.Raw_Ingredient_ID }}-qty">
                            </div>
                          </td>

                          <td>{{ ns.count }}. {{ rig.Raw_Ingredient_Name }}</td>
                          
                          <td>
                            <input type="number" id="{{ rig.Raw_Ingredient_ID }}-qty-instock" class="form-control d-none" name="{{ rig.Raw_Ingredient_ID }}-qty-instock" placeholder="Trong kho" disabled required>
                          </td>
                          
                          <td>
                            <input type="number" id="{{ rig.Raw_Ingredient_ID }}-qty-outstock" class="form-control d-none" name="{{ rig.Raw_Ingredient_ID }}-qty-outstock" placeholder="Ngoài kho" disabled required>
                          </td>
                        </tr>
                      {% endfor %}
                    
                    {% endfor %}

                    
                    
                  </tbody>
                </table>
              </div>
              
            </div>
          </div>
        
        {% elif tabname == 'items' %}
          
          <div class="card">
            <div class="card-body">
              
              <div id="stock-items-table-container" class="dt-responsive table-responsive p-1">
                
                <div class="stt-loading">
                  <span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>Loading, please wait...
                </div>

                

                <table id="dt-stock-items" class="table table-striped table-bordered table-sm align-middle">
                  
                </table>

              </div>
              
            </div>

          </div>
          
        {% else %}
          
          <div class="card">
            <div class="card-body">
              
              {{ 'here is ' ~ tabname }}

              
            </div>
          </div>
          
        {% endif %}
      
    </div>

  {% endfor %}

</div>

{% endblock %}
<!-- [ Main Content ] end -->



{% block extra_scripts %}

<script src="{{ request.url_for('static', path='js/plugins/choices.min.js') }}"></script>
<script src="{{ request.url_for('static', path='js/plugins/bouncer.min.js') }}"></script>
<script src="{{ request.url_for('static', path='js/pages/form-validation.js') }}"></script>
<script src="{{ request.url_for('static', path='js/plugins/sweetalert2.all.min.js') }}"></script>
<script src="{{ request.url_for('static', path='js/plugins/jquery.dataTables.min.js') }}"></script>
<script src="{{ request.url_for('static', path='js/plugins/dataTables.bootstrap5.min.js') }}"></script>

<script>
  // Tab INPUT
  $(function () {

    // Define input table
    const $dt_stock = $('#dt-stock').DataTable({
      responsive: true,  // let DataTables auto‑shrink & wrap columns
      scrollX:    false, // disable the horizontal scroll
      autoWidth:  true,  // allows table to grow to 100%
      ordering: false, // Prevent search columns

      // 1) Custom DOM: length + filter row on top, info + paginate row on bottom
      dom:
        "<'row g-2 p-2 mb-3'" +
        "<'col-sm-8'l>" +   // length menu here
        "<'col-sm-4'f>" +   // filter input here
        ">" +
        "t" +                 // the table itself
        "<'row g-2 p-2 mt-3'" +
          "<'col-sm-8'i>" +   // table info here
          "<'col-sm-4'p>" +   // pagination here
        ">",
      
      // 2) Language tweaks
      language: {
        lengthMenu: 'Show _MENU_ entries',
        search: '', // remove default “Search:” label
        searchPlaceholder: 'Search…',
        paginate: {
          first:    '<i class="ti ti-chevrons-left"></i>',
          previous: '<i class="ti ti-chevron-left"></i>',
          next:     '<i class="ti ti-chevron-right"></i>',
          last:     '<i class="ti ti-chevrons-right"></i>'
        }
      },

      // 3) Optional: how many rows by default
      pageLength: 100

    });

    $('.dataTables_length select').addClass('form-select form-select-sm');
    $('.dataTables_filter label').addClass('d-flex justify-content-end');
    $('.dataTables_filter input').addClass('form-control form-control-sm');
    

    // Define elements
    const $btn_stock_submit = $("#btn-stock-submit");
    const $qty_outstock_col = $dt_stock.column(3);


    // Clear all dt-stock input
    function fnc_clear_dtstock_input() {
      // uncheck ALL checkboxes across pages
      $dt_stock.$('input[type="checkbox"]').prop('checked', false).trigger('change');

      // clear text/number/date inputs
      $dt_stock.$('input[type="text"], input[type="number"], input[type="date"], input[type="time"]').val('').trigger('input');
    };

    // Create "on init items" function
    function fnc_init_input() {
      
      // On init disable submit button
      $btn_stock_submit.prop('disabled', true).find('.btn-text').text('Submit');
      $btn_stock_submit.find('.spinner-border').addClass('d-none');
      
      
      // On init hide column ngoài kho
      $qty_outstock_col.visible(false);

      // Clear all dt-stock input
      fnc_clear_dtstock_input();

      // clear method input
      $('#stock-method').val('');
      
    };


    // call initialize function
    fnc_init_input();


    $('#stock-method').on('change', function () {
      
      fnc_clear_dtstock_input();
      
      if ($(this).val() == 'add' || $(this).val() == 'get') {
        $qty_outstock_col.visible(false);
        $btn_stock_submit.prop('disabled', false);

      }
      else if ($(this).val() == 'check') {
        $qty_outstock_col.visible(true);
        $btn_stock_submit.prop('disabled', false);

      } else {
        $qty_outstock_col.visible(false);
        $btn_stock_submit.prop('disabled', true);
        
      }

    });

    $('.toggle-row').on('change', function () {
      const $qty_instock = $(`${$(this).data('target')}-instock`);
      const $qty_outstock = $(`${$(this).data('target')}-outstock`);

      $qty_instock.val(null);
      $qty_outstock.val(null);

      if (this.checked) {
        $qty_instock.removeClass('d-none').prop('disabled', false);
        $qty_outstock.removeClass('d-none').prop('disabled', false);
        
      } else {
        $qty_instock.addClass('d-none').prop('disabled', true);
        $qty_outstock.addClass('d-none').prop('disabled', true);
      }
    });


    $btn_stock_submit.on('click', function () {
      
      var total_qty = 0;
      const docs = [];

      $('#dt-stock tbody tr').each(function() {
        const $tr = $(this);
        
        const inVal  = parseFloat($tr.find(`input[id='${$tr.data('id')}-qty-instock']`).val()) || 0;
        const outVal = parseFloat($tr.find(`input[id='${$tr.data('id')}-qty-outstock']`).val()) || 0;
        
        if (inVal + outVal > 0)
        {
          total_qty += (inVal + outVal);

          docs.push({
            Raw_Ingredient_ID: $tr.data('id'),
            Location: $tr.data('loc'),
            Method: $('#stock-method').val(),
            Qty_Instock: inVal,
            Qty_Outstock: outVal,
          });
        }

      });

      if (total_qty == 0)
      {
        Swal.fire('Bạn chưa nhập bất kỳ số lượng nào!!!', '', 'error');
        return;
      }
      
      $btn_stock_submit.prop('disabled', true).find('.btn-text').text('Pleaese wait…');
      $btn_stock_submit.find('.spinner-border').removeClass('d-none');

      Swal.fire({
        title: `Bạn có muốn lưu dữ liệu đã nhập?`,
        showDenyButton: true,
        showCancelButton: false,
        confirmButtonText: `Lưu`,
        denyButtonText: `Không`
      }).then((result) => {
        
        if (result.isDenied) 
        {
          $btn_stock_submit.prop('disabled', false).find('.btn-text').text('Submit');
          $btn_stock_submit.find('.spinner-border').addClass('d-none');
          return;
        }
        else if (result.isConfirmed) {

          $.ajax({
            url: '/operation/stock/insert-items',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(docs),
            success: function(resp) {

              Swal.fire('Lưu dữ liệu thành công!', '', 'success').then(() => {
                fnc_init_input();
              });
              
            },
            error: function(xhr, status, err) {
              console.error(xhr);
              console.error(status);
              console.error(err);
              Swal.fire('Phát sinh lỗi. Dữ liệu chưa được lưu.', xhr.responseJSON.detail[0].msg, 'error');
            }
          });

        }

      });
      
    
    });
  
  
  });

  // Tab ITEMS
  $(function () {
    
    const $stock_items_container = $('#stock-items-table-container');
    const $stt_loading = $stock_items_container.find('.stt-loading');
    const $dt_stock_items = $('#dt-stock-items');

    // small helpers
    const esc = s => $('<div>').text(s ?? '').html();
    const num = v => (v ?? 0).toLocaleString('en-US', { maximumFractionDigits: 2 });
    const methodColor = m => ({ add: 'primary', get: 'warning', check: 'info' }[m] || 'info');

    function renderStockItemsTable(rows) {
      // destroy any existing DataTable instance
      if ($.fn.DataTable.isDataTable($dt_stock_items)) {
        $dt_stock_items.DataTable().destroy();
      }
      $dt_stock_items.empty();
      
      // define the columns you want
      const cols = [
        { title: '#'},
        { title: 'DateTime'},
        { title: 'By'},
        
        {% if user.role.lower() == 'admin' %}
          { title: 'Name'},
        {% endif %}
        
        { title: 'Method'},
        { title: 'Trong kho'},
        { title: 'Ngoài kho'},
      ];
      
      // build thead
      const thead = `<thead><tr>${cols.map(c => `<th>${c.title}</th>`).join('')}</tr></thead>`;
      
      // build tbody
      const tbody = `<tbody>
        ${rows.map((r, i) => `
          <tr data-id="${esc(r.id)}">

            <td>
              <div class="form-check">
                <input class="form-check-input toggle-row" type="checkbox">
              </div>
            </td>

            <td>${esc(r.DateTime)}</td>
            
            {% if user.role.lower() == 'admin' %}
              <td>${esc(r.email)}</td>
            {% endif %}

            <td>${esc(r.Raw_Ingredient_Name)}</td>
            <td>
              <span class="badge bg-light-${methodColor(r.Method)} border border-${methodColor(r.Method)}">
                ${esc(r.Method)}
              </span>
            </td>
            <td class="text-end">${num(r.Qty_Instock)}</td>
            <td class="text-end">${num(r.Qty_Outstock)}</td>
          </tr>
        `).join('')}
      </tbody>`;

      // insert and (re)initialize DataTables
      $dt_stock_items.html(thead + tbody).DataTable({
        dom:
          "<'row g-2 p-2 mb-3'<'col-sm-8'l><'col-sm-4'f>>" +
          "t" +
          "<'row g-2 p-2 mt-3'<'col-sm-8'i><'col-sm-4'p>>",
        pageLength: 10,
        order: [[0, 'desc']], // default sort by #; change if you prefer
        language: {
          lengthMenu: 'Show _MENU_ entries',
          search: '',
          searchPlaceholder: 'Search…',
          paginate: {
            first:    '<i class="ti ti-chevrons-left"></i>',
            previous: '<i class="ti ti-chevron-left"></i>',
            next:     '<i class="ti ti-chevron-right"></i>',
            last:     '<i class="ti ti-chevrons-right"></i>'
          }
        }
      });

      // style the controls for this table only
      const wrap = '#dt-stock-items_wrapper';
      $(wrap + ' .dataTables_length select').addClass('form-select form-select-sm');
      $(wrap + ' .dataTables_filter label').addClass('d-flex justify-content-end');
      $(wrap + ' .dataTables_filter input').addClass('form-control form-control-sm');
    }

    $stock_items_container.addClass('d-none');
    $stt_loading.removeClass('d-none');

    function fnc_init_stock_items() {
      
      $stt_loading.removeClass('d-none');

      $.ajax({
        url: '/operation/stock/retrieve-items',
        method: 'GET',
        success: function(resp) {

          renderStockItemsTable(resp);
          
        },
        error: function(xhr, status, err) {
          console.error(xhr);
          console.error(status);
          console.error(err);
          Swal.fire('Phát sinh lỗi.', xhr.responseJSON.detail[0].msg, 'error');
        }
      });

    }
    
    // fires when the Items pill becomes active
    $('#pills-items-tab').on('shown.bs.tab', function (e) {

      // e.target is the newly activated <a>
      console.log('#pills-items-tab activated!');

      $stt_loading.removeClass('d-none');
      $stock_items_container.addClass('d-none');

      fnc_init_stock_items?.();

      $stt_loading.addClass('d-none');
      $stock_items_container.removeClass('d-none');

    
    });

    // // also run on first load if it's already active
    // if ($('#pills-items').hasClass('active')) {
    //   console.log('#pills-items activated!');
    //   fnc_init_stock_items?.();
    // }



  });

  





</script>


{% endblock %}







